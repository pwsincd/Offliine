using System;
using Android.Util;
using Java.IO;
using Offliine.Injection.Util;

namespace Offliine.Injection.Exploit
{
    public class Payload
    {
        public static byte[] Generate(SystemVersion version, string payloadName)
        {
            try
            {
                var output = new ByteArrayOutputStream();

                var payload = InjectionHelper.ReadFile(new File(MainActivity.Payloads.Path, payloadName));
                var loader = InjectionHelper.ReadFile(new File(MainActivity.Loaders.Path, version.LoaderName));

                var padding = 0;
                while ((payload.Length + padding & 0x3) != 0)
                    padding++;

                output.Write(loader);
                InjectionHelper.WriteU32(payload.Length + padding, output);
                output.Write(payload);
                output.Write(new byte[padding]);

                output.Close();

                return output.ToByteArray();
            }
            catch (Exception e)
            {
                Log.Debug("Offliine", e.Message);
            }

            return null;
        }
    }
}